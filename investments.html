<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Investments | TheMarketBriefDaily</title>

<style>
:root{
  --bg:#ffffff;
  --ink:#0b1220;
  --muted: rgba(11,18,32,.68);
  --muted2: rgba(11,18,32,.46);
  --line: rgba(11,18,32,.12);
  --brand:#0b4ea2;
  --max: 1180px;
  --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Helvetica, Arial, sans-serif;
  --shadow: 0 18px 45px rgba(2,6,23,.10);
}
*{ box-sizing:border-box; }
html,body{ margin:0; padding:0; }
body{
  font-family: var(--font);
  color: var(--ink);
  background: var(--bg);
  line-height: 1.65;
  -webkit-font-smoothing: antialiased;
}
.container{ width: min(var(--max), calc(100% - 56px)); margin: 0 auto; }

.site-header{
  position: sticky; top: 0; z-index: 50;
  background: rgba(255,255,255,.92);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--line);
}
.header-inner{
  display:flex; align-items:center; justify-content:space-between;
  padding: 16px 0; gap: 24px;
}
.brand{ display:flex; flex-direction:column; gap:2px; }
.brand-title{ font-weight: 850; letter-spacing: -.2px; line-height: 1.1; }
.brand-sub{ font-size: 13px; color: var(--muted2); }

.nav{ display:flex; gap: 18px; align-items:center; flex-wrap:wrap; }
.nav a{
  color: var(--ink);
  font-weight: 650;
  font-size: 14px;
  padding: 10px 2px 8px;
  border-bottom: 2px solid transparent;
  text-decoration:none;
}
.nav a:hover{ border-bottom-color: rgba(11,18,32,.18); }
.nav a.is-active{ border-bottom-color: var(--ink); }

.section{ padding: 30px 0 44px; }
.kicker{
  font-size: 12px; letter-spacing: .16em; text-transform: uppercase;
  color: var(--muted2); margin-bottom: 10px;
}
h1{ margin:0 0 6px; font-size: 34px; letter-spacing: -.3px; }
.lead{ margin:0 0 18px; color: var(--muted); max-width: 95ch; }

.portfolio{
  border: 1px solid var(--line);
  border-radius: 16px;
  padding: 18px;
  background: #fff;
  box-shadow: var(--shadow);
}

.portfolio-top{
  display:flex; justify-content:space-between; gap: 16px;
  align-items:flex-start; flex-wrap: wrap;
}
.p-title{ font-weight: 850; letter-spacing: -.2px; }
.p-sub{ color: var(--muted2); font-size: 13px; margin-top: 4px; }

.statusline{ margin-top:8px; font-size:13px; color: var(--muted); }
.statusline strong{ color: var(--ink); }
.badge{
  display:inline-flex; align-items:center; gap:8px;
  padding: 6px 10px;
  border: 1px solid var(--line);
  border-radius: 999px;
  background:#fff;
  font-size:12px;
  color: var(--muted);
  margin-left: 10px;
}
.badge.ok{ border-color: rgba(10,122,58,.20); color: rgba(10,122,58,.95); }
.badge.warn{ border-color: rgba(180,35,24,.20); color: rgba(180,35,24,.92); }

.p-actions{ display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
.p-btn{
  display:inline-flex; align-items:center; justify-content:center;
  padding: 10px 12px; border-radius: 12px;
  border: 1px solid var(--line); background: #fff;
  color: var(--ink); font-weight: 750; cursor: pointer;
}
.p-btn:hover{ background: rgba(11,18,32,.03); }

.p-kpis{
  display:grid;
  grid-template-columns: repeat(4, minmax(160px, 1fr));
  gap: 12px;
  width: 100%;
  margin-top: 14px;
}
.kpi{
  border: 1px solid var(--line);
  border-radius: 14px;
  padding: 12px;
  background: #fff;
}
.kpi .label{
  font-size: 12px;
  color: var(--muted2);
  letter-spacing: .08em;
  text-transform: uppercase;
}
.kpi .value{
  font-weight: 850;
  margin-top: 6px;
  font-size: 18px;
}
.kpi .sub{ margin-top: 4px; color: var(--muted); font-size: 13px; }

.table-wrap{
  overflow:auto;
  border: 1px solid var(--line);
  border-radius: 16px;
  margin-top: 14px;
}
table{
  width: 100%;
  border-collapse: collapse;
  min-width: 1180px;
  background:#fff;
}
th, td{
  padding: 12px 12px;
  border-bottom: 1px solid var(--line);
  text-align: left;
  vertical-align: top;
  font-size: 14px;
}
th{
  font-size: 12px;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: var(--muted2);
  background: #fff;
  white-space: nowrap;
}
td small{ color: var(--muted2); }

.pos{ color: #0a7a3a; font-weight: 850; }
.neg{ color: #b42318; font-weight: 850; }
.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

.details{ margin-top: 14px; display:grid; gap: 10px; }
details{
  border: 1px solid var(--line);
  border-radius: 16px;
  background:#fff;
  padding: 12px 14px;
}
summary{ cursor:pointer; font-weight: 850; }
.tags{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
.tag{
  border:1px solid var(--line);
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  color: var(--muted);
}

.note{
  margin-top: 14px;
  padding-top: 14px;
  border-top: 1px solid var(--line);
  font-size: 13px;
  color: var(--muted);
}

@media (max-width: 900px){
  .container{ width: min(var(--max), calc(100% - 34px)); }
  .header-inner{ flex-direction: column; align-items:flex-start; }
  .p-kpis{ grid-template-columns: 1fr 1fr; }
}
</style>
</head>

<body>
<header class="site-header">
  <div class="container header-inner">
    <div class="brand">
      <div class="brand-title">TheMarketBriefDaily</div>
      <div class="brand-sub">Market structure · metals · macro</div>
    </div>
    <nav class="nav">
      <a href="./index.html">Home</a>
      <a class="is-active" href="./investments.html">Investments</a>
      <a href="./about.html">About</a>
      <a href="./disclaimer.html">Disclaimer</a>
    </nav>
  </div>
</header>

<main class="container section">
  <div class="kicker">Public model portfolio</div>
  <h1>Investments</h1>
  <p class="lead">
    Prices load from <span class="mono">./data/quotes.json</span> (shared across devices). If any ticker is missing, the page falls back to Alpha Vantage to fill the gaps.
  </p>

  <section class="portfolio">
    <div class="portfolio-top">
      <div>
        <div class="p-title">Portfolio Overview</div>
        <div class="p-sub">
          As of <span id="asof" class="mono">—</span> ·
          Last trading day: <span id="lastTS" class="mono">—</span> ·
          Quotes file timestamp: <span id="quotesAsOf" class="mono">—</span>
        </div>
        <div class="statusline">
          <strong>Status:</strong> <span id="quoteStatus" class="mono">loading…</span>
          <span id="healthBadge" class="badge" style="display:none;"></span>
          <span id="quoteError" style="display:none; margin-left:10px;" class="mono"></span>
        </div>
      </div>
      <div class="p-actions">
        <button class="p-btn" id="refreshQuotesBtn">Refresh intraday prices</button>
        <button class="p-btn" id="toggleThesisBtn">Expand all theses</button>
      </div>
    </div>

    <div class="p-kpis">
      <div class="kpi">
        <div class="label">Total Capital</div>
        <div class="value mono" id="totalCap">—</div>
        <div class="sub">Model capital.</div>
      </div>
      <div class="kpi">
        <div class="label">Portfolio Value (NAV)</div>
        <div class="value mono" id="nav">—</div>
        <div class="sub">Holdings + constant cash.</div>
      </div>
      <div class="kpi">
        <div class="label">P/L</div>
        <div class="value mono" id="pl">—</div>
        <div class="sub">Mark-to-market vs cost basis.</div>
      </div>
      <div class="kpi">
        <div class="label">Since Inception</div>
        <div class="value mono" id="si">—</div>
        <div class="sub">Return vs initial capital.</div>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Asset</th>
            <th>Ticker</th>
            <th class="mono">Shares</th>
            <th class="mono">Entry</th>
            <th class="mono">Last</th>
            <th class="mono">Cost</th>
            <th class="mono">Mkt Value</th>
            <th class="mono">P/L ($)</th>
            <th class="mono">P/L (%)</th>
            <th>Stage</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="details" id="thesisBlocks"></div>

    <div class="note">
      <strong>Disclosure:</strong> informational model portfolio only; not investment advice.
    </div>
  </section>
</main>

<script>
/* ========= CONFIG ========= */
const AV_KEY = "GUY8S89NSG15NVYH";
const QUOTE_DELAY_MS = 14000;

const TOTAL_CAPITAL = 100000;

// Small allocations (rest stays constant cash)
const targetDollars = { AGI:2000, FSM:1500, GAU:1000, NFGC:800, VGZ:700, NEWP:1000 };

// Entry prices
const entry = { AGI:42.19, FSM:10.39, GAU:2.73, NFGC:2.69, VGZ:2.63, NEWP:3.53 };

// Meta + thesis
const meta = {
  AGI:{ name:"Alamos Gold", stage:"Producer", thesis:["Established producer; lower relative risk.","Watch AISC and guidance execution.","Sized small; cycle+execution."], watch:["AISC","guidance","capex","jurisdiction"] },
  FSM:{ name:"Fortuna Mining", stage:"Producer", thesis:["Gold/silver hybrid with diversification.","Satellite position; margin expansion thesis.","Sized small due to miner beta."], watch:["costs","jurisdiction","balance sheet","metal sensitivity"] },
  GAU:{ name:"Galiano Gold", stage:"Turnaround / Small Cap", thesis:["Turnaround/execution story.","Single-asset concentration acknowledged.","Sized small for idiosyncratic risk."], watch:["resource","operations","financing","country risk"] },
  NFGC:{ name:"New Found Gold", stage:"Developer", thesis:["High-grade optionality; pre-revenue.","Financing/dilution + timeline risk.","Very small sizing."], watch:["drilling","permits","financing","timeline"] },
  VGZ:{ name:"Vista Gold", stage:"Developer", thesis:["Long-dated gold leverage.","Milestone-driven rerating.","Small sizing due to timeline."], watch:["milestones","partnering","capex","jurisdiction"] },
  NEWP:{ name:"New Pacific Metals", stage:"Developer (Silver)", thesis:["Silver optionality.","High jurisdiction/political risk.","Cycle+advancement thesis."], watch:["policy","community","resource","silver cycle"] }
};

const tickers = Object.keys(targetDollars);
const shares = Object.fromEntries(tickers.map(t => [t, targetDollars[t] / entry[t]]));

// Constant cash FIX
const INITIAL_INVESTED = Object.values(targetDollars).reduce((a,b)=>a+b,0);
const INITIAL_CASH = Math.max(0, TOTAL_CAPITAL - INITIAL_INVESTED);

/* ========= UTIL ========= */
const el = id => document.getElementById(id);
const fmtUSD0 = n => n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0});
const fmtUSD2 = n => n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2});
const fmtPct = n => (n>=0?"+":"") + n.toFixed(2) + "%";
const sleep = ms => new Promise(r=>setTimeout(r,ms));

function setError(msg){
  const e = el("quoteError");
  if(!msg){ e.style.display="none"; e.textContent=""; return; }
  e.style.display="inline";
  e.style.color="#b42318";
  e.textContent = "· " + msg;
}

function setBadge(kind, text){
  const b = el("healthBadge");
  b.style.display = "inline-flex";
  b.className = "badge " + (kind === "ok" ? "ok" : "warn");
  b.textContent = text;
}

function normalizePrices(prices){
  // returns a new object of numeric prices only
  const out = {};
  if(!prices || typeof prices !== "object") return out;
  for(const [k,v] of Object.entries(prices)){
    const sym = String(k).trim().toUpperCase();
    const num = (typeof v === "number") ? v : Number(String(v).replace(/[^0-9.\-]/g,""));
    if(sym && Number.isFinite(num) && num > 0) out[sym] = num;
  }
  return out;
}

/* ========= SHARED QUOTES ========= */
async function loadSharedQuotes(){
  const res = await fetch("./data/quotes.json?cb=" + Date.now(), { cache: "no-store" });
  if(!res.ok) throw new Error("Failed to load ./data/quotes.json");
  return await res.json();
}

/* ========= ALPHA VANTAGE QUOTE ========= */
async function fetchQuote(symbol){
  const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${encodeURIComponent(symbol)}&apikey=${encodeURIComponent(AV_KEY)}`;
  const res = await fetch(url, {cache:"no-store"});
  const data = await res.json();
  if(data.Note) throw new Error("Rate limited by Alpha Vantage. Wait ~60s then try again.");
  if(data["Error Message"]) throw new Error("Alpha Vantage error for " + symbol);
  const q = data["Global Quote"];
  if(!q || !q["05. price"]) throw new Error("No quote returned for " + symbol);
  const price = Number(q["05. price"]);
  if(!Number.isFinite(price) || price <= 0) throw new Error("Bad price returned for " + symbol);
  return { price, ts: (q["07. latest trading day"] || "") };
}

/* ========= TABLE + KPI ========= */
function renderTableSkeleton(){
  const tbody = el("rows");
  tbody.innerHTML = "";
  for(const t of tickers){
    const sh = shares[t];
    const cost = sh * entry[t];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${meta[t].name}</strong><br/><small>${meta[t].stage}</small></td>
      <td class="mono"><strong>${t}</strong></td>
      <td class="mono">${sh.toFixed(4)}</td>
      <td class="mono">${fmtUSD2(entry[t])}</td>
      <td class="mono" id="last_${t}">—</td>
      <td class="mono">${fmtUSD0(cost)}</td>
      <td class="mono" id="mv_${t}">—</td>
      <td class="mono" id="pl_${t}">—</td>
      <td class="mono" id="plp_${t}">—</td>
      <td>${meta[t].stage}</td>
    `;
    tbody.appendChild(tr);
  }
}

function updateRow(t, price){
  const sh = shares[t];
  const mv = sh * price;
  const cost = sh * entry[t];
  const pl = mv - cost;
  const plPct = (pl / cost) * 100;
  const cls = pl >= 0 ? "pos" : "neg";

  el(`last_${t}`).textContent = fmtUSD2(price);
  el(`mv_${t}`).textContent = fmtUSD0(mv);

  const plEl = el(`pl_${t}`);
  plEl.textContent = fmtUSD0(pl);
  plEl.className = `mono ${cls}`;

  const plpEl = el(`plp_${t}`);
  plpEl.textContent = fmtPct(plPct);
  plpEl.className = `mono ${cls}`;
}

function updateKPIs(latestPx){
  let holdingsMV = 0;
  let plTotal = 0;
  let pricedCount = 0;

  for(const t of tickers){
    const px = latestPx[t];
    if(!px) continue;
    pricedCount++;
    const sh = shares[t];
    const mv = sh * px;
    const cost = sh * entry[t];
    holdingsMV += mv;
    plTotal += (mv - cost);
  }

  const nav = holdingsMV + INITIAL_CASH;
  const si = ((nav / TOTAL_CAPITAL) - 1) * 100;

  el("totalCap").textContent = fmtUSD0(TOTAL_CAPITAL);

  if(pricedCount === 0){
    el("nav").textContent = "—";
    el("pl").textContent = "—";
    el("si").textContent = "—";
  } else {
    el("nav").textContent = fmtUSD0(nav);
    el("pl").textContent = (plTotal>=0?"+":"") + fmtUSD0(plTotal);
    el("si").textContent = fmtPct(si);
  }
}

function renderTheses(){
  const wrap = el("thesisBlocks");
  wrap.innerHTML = "";
  for(const t of tickers){
    const d = document.createElement("details");
    d.innerHTML = `
      <summary>${meta[t].name} <span class="mono" style="color:rgba(11,18,32,.46); font-weight:650;">(${t})</span></summary>
      <div class="note" style="border-top:none; padding-top:8px;">
        <div class="kicker" style="margin:0 0 6px;">Thesis</div>
        <ul style="margin:0 0 10px 18px; color:rgba(11,18,32,.68);">
          ${meta[t].thesis.map(x=>`<li>${x}</li>`).join("")}
        </ul>
        <div class="kicker" style="margin:0 0 6px;">What to watch</div>
        <div class="tags">
          ${meta[t].watch.map(w=>`<span class="tag">${w}</span>`).join("")}
        </div>
      </div>
    `;
    wrap.appendChild(d);
  }
}

/* ========= LOAD FLOW ========= */
async function applyPricesEverywhere(prices){
  // prices is normalized numeric map
  for(const t of tickers){
    if(prices[t]) updateRow(t, prices[t]);
  }
  updateKPIs(prices);
}

async function fillMissingViaAlphaVantage(prices){
  // For any ticker missing, fetch one-by-one (rate-limited)
  let lastTradingDay = "";
  for(let i=0;i<tickers.length;i++){
    const t = tickers[i];
    if(prices[t]) continue;

    el("quoteStatus").textContent = `filling missing: ${t}…`;
    try{
      const q = await fetchQuote(t);
      prices[t] = q.price;
      updateRow(t, q.price);
      updateKPIs(prices);
      if(q.ts && q.ts > lastTradingDay) lastTradingDay = q.ts;
    }catch(e){
      setError(e.message);
      // don't stop the whole process; continue
    }
    await sleep(QUOTE_DELAY_MS);
  }
  return lastTradingDay;
}

/* ========= MANUAL REFRESH ========= */
async function refreshAllViaAlphaVantage(){
  setError("");
  const prices = {};
  el("quoteStatus").textContent = "refreshing intraday (rate-limited)…";

  let lastTradingDay = "";
  for(let i=0;i<tickers.length;i++){
    const t = tickers[i];
    el("quoteStatus").textContent = `fetching ${t} (${i+1}/${tickers.length})…`;
    try{
      const q = await fetchQuote(t);
      prices[t] = q.price;
      updateRow(t, q.price);
      updateKPIs(prices);
      if(q.ts && q.ts > lastTradingDay) lastTradingDay = q.ts;
    }catch(e){
      setError(e.message);
      el("quoteStatus").textContent = "error";
      return;
    }
    if(i < tickers.length - 1) await sleep(QUOTE_DELAY_MS);
  }

  el("lastTS").textContent = lastTradingDay || el("lastTS").textContent;
  el("quoteStatus").textContent = "ok (intraday refreshed)";
  setBadge("ok", "intraday");
}

/* ========= BUTTONS ========= */
let expanded = false;
el("toggleThesisBtn").addEventListener("click", ()=>{
  const blocks = document.querySelectorAll("#thesisBlocks details");
  expanded = !expanded;
  blocks.forEach(d => d.open = expanded);
  el("toggleThesisBtn").textContent = expanded ? "Collapse all theses" : "Expand all theses";
});
el("refreshQuotesBtn").addEventListener("click", refreshAllViaAlphaVantage);

/* ========= INIT ========= */
(async function init(){
  el("asof").textContent = new Date().toLocaleDateString(undefined,{year:"numeric",month:"short",day:"2-digit"});
  el("totalCap").textContent = fmtUSD0(TOTAL_CAPITAL);

  renderTableSkeleton();
  renderTheses();

  try{
    const q = await loadSharedQuotes();

    el("quotesAsOf").textContent = q.asof_iso ? q.asof_iso : "—";
    el("lastTS").textContent = q.last_trading_day || "—";

    const prices = normalizePrices(q.prices);
    await applyPricesEverywhere(prices);

    // Health info
    const have = Object.keys(prices).length;
    if(have === tickers.length){
      el("quoteStatus").textContent = "auto-loaded (shared quotes)";
      setBadge("ok", "shared quotes complete");
    } else {
      el("quoteStatus").textContent = `shared quotes partial (${have}/${tickers.length})`;
      setBadge("warn", "missing symbols — filling");
      const extraDay = await fillMissingViaAlphaVantage(prices);
      if(extraDay) el("lastTS").textContent = extraDay;
      const have2 = Object.keys(prices).length;
      el("quoteStatus").textContent = `ready (${have2}/${tickers.length} priced)`;
    }

  }catch(e){
    el("quoteStatus").textContent = "no shared quotes (yet)";
    setBadge("warn", "no quotes.json");
    setError("Create data/quotes.json (and schedule updates) or use manual refresh.");
  }
})();
</script>
</body>
</html>
